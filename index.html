<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>My map</title>
    <script  type="text/javascript" src="lib/d3.v5.min.js"></script>
    <script  type="text/javascript" src="lib/d3-dsv.min.js"></script>
    <script  type="text/javascript" src="lib/d3-tip.min.js"></script>
    <script  type="text/javascript" src="lib/topojson.v2.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <style></style>
</head>
<style>
    div.tooltip {
        position: absolute;
        left: 75px;
        text-align: center;
        height: 60px;
        padding: 10px;
        font-size: 14px;
        background: #FFFFFF;
        border: 1px solid #989898;
        pointer-events: none;
    }
</style>
<body>
<div id="container" class="svg-container"></div>
<script type="text/javascript">
    // width and height of map
    var width = window.innerWidth;
    var height = window.innerHeight;

    // D3 Projection
    var projection = d3.geoAlbersUsa()
        .translate([width / 2, height / 2]) // translate to center of screen
        .scale([1500]); // scale things down so see entire US

    // Define path generator
    var path = d3.geoPath() // path generator that will convert GeoJSON to SVG paths
        .projection(projection); // tell path generator to use albersUsa projection

    // Create SVG element and append map to the SVG
    var svg = d3.select("div#container")
        .append("svg")
        .attr("preserveAspectRatio", "xMinYMin meet")
        .style("background-color","#c9e8fd")
        .attr("viewBox", "0 0 " + width + " " + height)
        .classed("svg-content", true);

         svg.append("text")
            .attr("x", (width / 2))
            .attr("y", 35)
            .attr("text-anchor", "middle")
            .attr("font-size",30)
            .text("COVID-19 Vaccine Efficacy Tracker");


    var div = d3.select("div#container")
        .append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

    // Add a g element to group SVG shapes together
    var g = svg.append("g");

    d3.dsv(",", "us-counties-clean.csv", function(d) { 
        return {
            date: d.date,
            id: +d["geoid"],
            county: d.county,
            state: d.state,
            cases: d.cases
        }
    }).then(function(data) {
        dataset = data
        console.log(dataset)
    })

    // load and display the World
    d3.json("us-counties.json").then(function(topology) {
        g.selectAll("path")
            .data(topojson.feature(topology, topology.objects.counties).features)
            .enter().append("path")
            .attr("d", path)
            .style("fill", "lightgray")
            .style("stroke", "white")
            .style("stroke-width", 0.333)

            //
            .on("mouseover", function(d) {
                elem = dataset.find(function(l) { return l.id == d.id})
                div.transition().duration(300)
                    .style("opacity", 1)
                div.html(function(d) {
                    if (elem != null) {
                        return "County: " + elem.county 
                        + "<BR/> Date: " + elem.date
                        + "<BR/> Cases: " + elem.cases
                        + "<BR/> Forecasted cases: "
                    }
                })
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY -30) + "px")
                d3.select(this)
                    // .transition()
                    // .duration(300)
                    .style("fill", "yellow")
            })

            //
            .on("mouseout", function(d) {
                d3.select(this)
                    // .transition()
                    // .duration(300)
                    .style("fill", "lightgray")
            });
    });

    // Add Pan and Zoom functionality
    var zoom = d3.zoom()
        .scaleExtent([1, 8])
        .on('zoom', function() {
            g.selectAll('path')
                .attr('transform', d3.event.transform);
        });

    svg.call(zoom)

</script>
</body>
</html>