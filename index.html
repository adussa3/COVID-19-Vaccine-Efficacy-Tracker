<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>My map</title>
    <script  type="text/javascript" src="lib/d3.v5.min.js"></script>
    <script  type="text/javascript" src="lib/d3-dsv.min.js"></script>
    <script  type="text/javascript" src="lib/d3-tip.min.js"></script>
    <script  type="text/javascript" src="lib/topojson.v2.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <style></style>
</head>
<style>
    div.tooltip {
        position: absolute;
        left: 75px;
        text-align: center;
        height: 80px;
        padding: 10px;
        font-size: 14px;
        background: #FFFFFF;
        border: 1px solid #989898;
        pointer-events: none;
    }
</style>
<body>
<h1>COVID-19 Vaccine Efficacy Tracker</h1>
<label>Select Date: <select id="selectButton"></select></label>
<div id="container" class="svg-container"></div>
<script type="text/javascript">
    // width and height of map
    var width = window.innerWidth;
    var height = window.innerHeight - 50;

    // D3 Projection
    var projection = d3.geoAlbersUsa()
        .translate([width / 2, height / 2]) // translate to center of screen
        .scale([1500]); // scale things down so see entire US

    // Define path generator
    var path = d3.geoPath() // path generator that will convert GeoJSON to SVG paths
        .projection(projection); // tell path generator to use albersUsa projection

    // Create SVG element and append map to the SVG
    var svg = d3.select("div#container")
        .append("svg")
        .attr("preserveAspectRatio", "xMinYMin meet")
        .style("background-color","white")
        .attr("viewBox", "0 0 " + width + " " + height)
        .classed("svg-content", true);

         svg.append("text")
            .attr("x", (width / 2))
            .attr("y", 35)
            .attr("text-anchor", "middle")
            .attr("font-size",30)
            .text("COVID-19 Vaccine Efficacy Tracker");


    var div = d3.select("div#container")
        .append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

    // Add a g element to group SVG shapes together
    var g = svg.append("g");


    Promise.all([
            // enter code to read files
            d3.json("us-counties.json"),
            d3.dsv(",", "us-counties-clean.csv", function(d) { 
                return {
                    date: d.date,
                    id: +d["geoid"],
                    county: d.county,
                    state: d.state,
                    cases: d.cases
                }
            }).then(function(data) {
                dataset = data
            }),
            d3.dsv(",", "us_state_vaccinations_clean.csv", function(d) { 
                return {
                    date: d.date,
                    location: d.location,
                    total_vaccinations: +d.total_vaccinations
                }
            }).then(function(data) {
                vaccineData = data
            })
        ]).then(function(values) {
            ready(values[0], dataset, vaccineData)
        });


    // Add Pan and Zoom functionality
    var zoom = d3.zoom()
        .scaleExtent([1, 8])
        .on('zoom', function() {
            g.selectAll('path')
                .attr('transform', d3.event.transform);
        });

    svg.call(zoom)

    function ready(topology, dataset, vaccineData) {

        // Add drop down
        dates = []
        dataset.forEach(function(d) {
            if (!dates.includes(d.date)) {
                dates.push(d.date)
            }
        });
        var options = d3.select("#selectButton")
            .selectAll('option')
            .data(dates)
            .enter()
            .append('option')
            .text(function (d) { return d;})
            .attr("value", function (d) { return d; })
            .property("selected", function(d) {return d === dates[200]})
        d3.select("#selectButton").on("change", function(d) {
            d3.selectAll("#currDate").remove()
            var selectedDate = d3.select(this).property("value")
            createMapAndLegend(topology, dataset, vaccineData,selectedDate)
        })
        createMapAndLegend(topology, dataset, vaccineData,dates[200])
    }

    function createMapAndLegend(topology, dataset, vaccineData, selectedDate){
        dataset = dataset.filter(function (d){return d.date == selectedDate})
        vaccineData = vaccineData.filter(function (d){return d.date == selectedDate})

        if (vaccineData.length != 0) {
            var max = 0
            vaccineData.forEach(function(d) {
                if (d.total_vaccinations > max) {
                    max = d.total_vaccinations
                }
            });
            var min = vaccineData[0].total_vaccinations
            vaccineData.forEach(function(d) {
                if (d.total_vaccinations < min) {
                    min = d.total_vaccinations
                }
            });
        }

        var color = d3.scaleLinear()
          .domain([min, max])
          .range(["#a6bce2","#032152"])
          .interpolate(d3.interpolateLab);


        g.selectAll("path")
        .data(topojson.feature(topology, topology.objects.counties).features)
        .enter().append("path")
        .attr("d", path)
        .attr("id","currDate")
        .style("stroke", "white")
        .style("stroke-width", 0.333)
        .attr("fill", function (d) {
            elem = dataset.find(function(l) { return l.id == d.id})
            if (elem != null) { 
                vaccineElem = vaccineData.find(function(l) { return l.location == elem.state})
                if (vaccineElem != null) {
                    return color(vaccineElem.total_vaccinations)
                }
            }
            return "grey"
        })
        .on("mouseover", function(d) {
            elem = dataset.find(function(l) { return l.id == d.id})
            div.transition().duration(300).style("opacity", 1)
            div.html(function(d) {
                var text = ""
                if (elem != null) {
                    text = text + "County: " + elem.county 
                    + "<BR/> New cases: " + elem.cases
                    vaccineElem = vaccineData.find(function(l) { return l.location == elem.state})
                    if (vaccineElem != null) {
                    text = text + "<BR/> " + elem.state + " Vacinations: " + vaccineElem.total_vaccinations
                    } else {
                        text = text + "<BR/> " + elem.state + " Vacinations: " + "Not available"
                    }
                } else {
                    text = text + "County: Not available"
                    + "<BR/> New cases: Not available"
                }
                text = text + "<BR/> Forecasted cases: "
                return text
            })
            .style("left", (d3.event.pageX) + "px")
            .style("top", (d3.event.pageY -30) + "px")
        })
        .on("mouseout", function(d) {
            d3.select(this)
                // .transition()
                // .duration(300)
                // .style("fill", "lightgray")
        });
    }

</script>
</body>
</html>